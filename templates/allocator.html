<form id="skill-form">
  <h2>Distribuir Pontos de Perícia</h2>
  <p>
    Total disponível: <span id="total-pontos">{{totalPoints}}</span> |
    Gastos: <span id="pontos-gastos">0</span> |
    Restantes: <span id="pontos-restantes">{{totalPoints}}</span>
  </p>

  <table>
    <thead>
      <tr>
        <th>Perícia</th>
        <th>Atributo</th>
        <th>Mod</th>
        <th>Pontos</th>
        <th>Mod Extra</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {{#each skills as |skill key|}}
      <tr class="skill-row" data-skill-key="{{key}}">
        <td>{{skill.label}}</td>
        <td>{{skill.ability}}</td>
        <td>{{#if (gt skill.modAttr 0)}}+{{/if}}{{skill.modAttr}}</td>
        <td>
          <input type="number" name="skills.{{key}}" class="skill-input" value="{{skill.pontos}}" min="0" />
        </td>
        <td>
          <input type="number" name="mods.{{key}}" class="mod-input" value="{{skill.modExtra}}" />
        </td>
        <td class="skill-total">+{{skill.total}}</td>
      </tr>
      {{/each}}
    </tbody>
  </table>

  <hr>
  <h3>Idiomas Personalizados</h3>
  <div id="idiomas-lista">
    {{#each idiomas as |valor nome|}}
    <div class="idioma-linha">
      <input name="idiomaNome.{{@index}}" type="text" value="{{nome}}" placeholder="Nome do idioma" />
      <input name="idiomaValor.{{@index}}" class="idioma-input" type="number" value="{{valor}}" min="0" />
    </div>
    {{/each}}
  </div>
  <button type="button" onclick="addIdioma()">Adicionar Idioma</button>

  <hr>
  <button type="submit" id="submit-button">Salvar</button>
</form>

<script>
  function atualizarResumo() {
    const total = parseInt(document.getElementById("total-pontos").textContent);
    const gastosEl = document.getElementById("pontos-gastos");
    const restantesEl = document.getElementById("pontos-restantes");
    const submitBtn = document.getElementById("submit-button");

    const skillInputs = document.querySelectorAll(".skill-input");
    const idiomaInputs = document.querySelectorAll(".idioma-input");

    let gastos = 0;

    skillInputs.forEach(input => {
      const pontos = parseInt(input.value) || 0;
      gastos += pontos;

      const row = input.closest("tr");
      if (!row) return;

      const modAttr = parseInt(row.querySelector("td:nth-child(3)")?.textContent) || 0;
      const modExtra = parseInt(row.querySelector(".mod-input")?.value || 0);
      const isIdioma = row.dataset.skillKey?.startsWith("idiomas_");

      const prof = (pontos > 0) ? (game.user.character?.system?.attributes?.prof || 0) : 0;

      let totalMod = 0;

      if (isIdioma) {
        totalMod = pontos + prof;
      } else if (pontos > 0) {
        totalMod = pontos + modAttr + prof + modExtra;
      } else {
        totalMod = modAttr;
      }

      const cell = row.querySelector(".skill-total");
      if (cell) cell.textContent = totalMod >= 0 ? `+${totalMod}` : `${totalMod}`;
    });

    idiomaInputs.forEach(input => {
      const pontos = parseInt(input.value) || 0;
      gastos += pontos;
    });

    gastosEl.textContent = gastos;
    const restantes = total - gastos;
    restantesEl.textContent = restantes;

    if (restantes < 0) {
      restantesEl.style.color = "red";
      submitBtn.disabled = true;
    } else {
      restantesEl.style.color = "";
      submitBtn.disabled = false;
    }
  }

  function addIdioma() {
    const container = document.getElementById("idiomas-lista");
    const index = container.children.length;
    const div = document.createElement("div");
    div.className = "idioma-linha";
    div.innerHTML = `
      <input name="idiomaNome.${index}" type="text" placeholder="Nome do idioma" />
      <input name="idiomaValor.${index}" class="idioma-input" type="number" value="0" min="0" />
    `;
    container.appendChild(div);
    div.querySelector(".idioma-input").addEventListener("input", atualizarResumo);
    atualizarResumo();
  }

  document.addEventListener("input", (event) => {
    if (
      event.target.matches(".skill-input") ||
      event.target.matches(".mod-input") ||
      event.target.matches(".idioma-input")
    ) {
      atualizarResumo();
    }
  });

  document.getElementById("skill-form").addEventListener("submit", function (e) {
    const total = parseInt(document.getElementById("total-pontos").textContent);
    const gastos = parseInt(document.getElementById("pontos-gastos").textContent);
    if (gastos > total) {
      e.preventDefault();
      ui.notifications.warn("Você gastou mais pontos do que o disponível.");
    }
  });

  atualizarResumo();
</script>